{% layout 'theme' %}
<div class="state-fair-deals-page">
  <h1>2025 State Fair Deals</h1>
  <div class="page-content">
    <!-- Sidebar for vendor prefix filtering -->
    <div class="sidebar">
      <h2>Filter by Product</h2>
      <ul class="vendor-list">
        <li><a href="#" data-filter="all" class="vendor-link active">All Products</a></li>
        {% assign collection = collections['2025-state-fair-sale'] %}
        {% paginate collection.products by 1000 %}
          {% assign vendor_prefixes = '' %}
          {% for product in collection.products %}
            {% assign title = product.title | strip | default: 'Unknown' %}
            {% assign words = title | replace: '®', '' | split: ' ' %}
            {% if title contains 'BEDRUG' %}
              {% assign prefix = 'BEDRUG' %}
            {% elsif title contains 'Lo Pro' %}
              {% assign prefix = 'Lo Pro' %}
            {% elsif title contains 'Sentry CT' %}
              {% assign prefix = 'Sentry CT' %}
            {% elsif title contains 'TONNOSPORT' %}
              {% assign prefix = 'TONNOSPORT' %}
            {% elsif title contains 'TruXport' %}
              {% assign prefix = 'TruXport' %}
            {% elsif title contains 'VANISH' %}
              {% assign prefix = 'VANISH' %}
            {% else %}
              {% assign prefix = words | slice: 0, 2 | join: ' ' | default: 'Unknown' %}
            {% endif %}
            {% unless vendor_prefixes contains prefix %}
              {% if vendor_prefixes == '' %}
                {% assign vendor_prefixes = prefix %}
              {% else %}
                {% assign vendor_prefixes = vendor_prefixes | append: '|' | append: prefix %}
              {% endif %}
            {% endunless %}
          {% endfor %}
          {% assign sorted_prefixes = vendor_prefixes | split: '|' | sort %}
          {% if sorted_prefixes.size > 0 %}
            {% for prefix in sorted_prefixes %}
              <li><a href="#" data-filter="{{ prefix | escape }}" class="vendor-link">{{ prefix | escape }}</a></li>
            {% endfor %}
          {% else %}
            <li>No products found. Verify product titles in Shopify admin.</li>
          {% endif %}
        {% endpaginate %}
      </ul>
    </div>
    <!-- Main product display -->
    <div class="main-content">
      {% assign collection = collections['2025-state-fair-sale'] %}
      {% if collection %}
        {% paginate collection.products by 50 %}
          <div class="collection-products">
            {% assign sorted_products = collection.products | sort: 'title' %}
            {% assign current_prefix = '' %}
            {% for product in sorted_products %}
              {% assign title = product.title | strip | default: 'Unknown' %}
              {% assign words = title | replace: '®', '' | split: ' ' %}
              {% if title contains 'BEDRUG' %}
                {% assign prefix = 'BEDRUG' %}
              {% elsif title contains 'Lo Pro' %}
                {% assign prefix = 'Lo Pro' %}
              {% elsif title contains 'Sentry CT' %}
                {% assign prefix = 'Sentry CT' %}
              {% elsif title contains 'TONNOSPORT' %}
                {% assign prefix = 'TONNOSPORT' %}
              {% elsif title contains 'TruXport' %}
                {% assign prefix = 'TruXport' %}
              {% elsif title contains 'VANISH' %}
                {% assign prefix = 'VANISH' %}
              {% else %}
                {% assign prefix = words | slice: 0, 2 | join: ' ' | default: 'Unknown' %}
              {% endif %}
              {% if prefix != current_prefix %}
                <h2 class="prefix-group" data-prefix="{{ prefix | escape }}">{{ prefix | escape }}</h2>
                {% assign current_prefix = prefix %}
              {% endif %}
              <div class="product-item" data-prefix="{{ prefix | escape }}">
                <a href="{{ product.url }}">
                  <div class="product-image">
                    <img src="{{ product.featured_image | img_url: '250x250' | default: 'https://via.placeholder.com/250' }}" alt="{{ product.title | escape | default: 'No Title' }}">
                  </div>
                  <h3>{{ product.title | truncate: 60 | escape | default: 'No Title' }}</h3>
                  {% if customer and product.metafields.custom.state_fair_price %}
                    <span class="price original-price">Original: <s>{{ product.price | money }}</s></span>
                    <span class="price state-fair-price">Sale: {{ product.metafields.custom.state_fair_price | times: 100 | money }}</span>
                  {% else %}
                    <span class="price regular-price">{{ product.price | money }}</span>
                  {% endif %}
                </a>
              </div>
            {% endfor %}
          </div>
          {% if paginate.pages > 1 %}
            <div class="pagination">
              {{ paginate | default_pagination }}
            </div>
          {% endif %}
        {% endpaginate %}
      {% else %}
        <p>No products available in this collection. Check collection handle or product assignments.</p>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .state-fair-deals-page {
    display: flex;
    flex-direction: column;
    max-width: 100%;
    margin: 0 auto;
    padding: 20px;
  }
  .page-content {
    display: flex;
    gap: 20px;
  }
  .sidebar {
    width: 250px;
    flex-shrink: 0;
  }
  .vendor-list {
    list-style: none;
    padding: 0;
  }
  .vendor-list li {
    margin-bottom: 10px;
  }
  .vendor-link {
    text-decoration: none;
    color: #333;
    font-weight: bold;
  }
  .vendor-link.active,
  .vendor-link:hover {
    color: #33ff44;
  }
  .main-content {
    flex-grow: 1;
  }
  .collection-products {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }
  .product-item {
    text-align: center;
  }
  .product-item.hidden {
    display: none;
  }
  .prefix-group {
    display: block;
  }
  .prefix-group.hidden {
    display: none;
  }
  .state-fair-price {
    color: #33ff44;
    font-weight: bold;
    display: block;
  }
  .original-price {
    color: #666;
    font-size: 0.9em;
    display: block;
  }
  .original-price s {
    color: #999;
  }
  .regular-price {
    color: #333;
    font-weight: bold;
    display: block;
  }
  .pagination {
    text-align: center;
    margin-top: 20px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.vendor-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const filter = this.getAttribute('data-filter');
        document.querySelectorAll('.vendor-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.product-item, .prefix-group').forEach(item => {
          if (filter === 'all' || item.getAttribute('data-prefix') === filter) {
            item.classList.remove('hidden');
          } else {
            item.classList.add('hidden');
          }
        });
      });
    });
  });
</script>