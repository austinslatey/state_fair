{% layout 'theme' %}
<div class="state-fair-deals-page">
  <h1>2025 State Fair Deals</h1>
  <div class="page-content">
    <!-- Sidebar for title prefix filtering -->
    <div class="sidebar">
      <h2>Filter by Product</h2>
      <ul class="vendor-list">
        <li><a href="#" data-filter="all" class="vendor-link active">All Products</a></li>
        {% assign collection = collections['2025-state-fair-sale'] %}
        {% paginate collection.products by 1000 %}
          {% assign title_prefixes = '' %}
          {% for product in collection.products %}
            {% assign title = product.title | strip | default: 'Unknown' %}
            {% assign words = title | split: ' ' %}
            {% if words.size >= 2 %}
              {% assign prefix = words | slice: 0, 2 | join: ' ' %}
            {% else %}
              {% assign prefix = title %}
            {% endif %}
            {% unless title_prefixes contains prefix %}
              {% if title_prefixes == '' %}
                {% assign title_prefixes = prefix %}
              {% else %}
                {% assign title_prefixes = title_prefixes | append: '|' | append: prefix %}
              {% endif %}
            {% endunless %}
          {% endfor %}
          {% assign sorted_prefixes = title_prefixes | split: '|' | sort %}
          {% if sorted_prefixes.size > 0 %}
            {% for prefix in sorted_prefixes %}
              <li>
                <a href="#" data-filter="{{ prefix | escape }}" class="vendor-link">{{ prefix | escape }}</a>
              </li>
            {% endfor %}
          {% else %}
            <li>No products found. Verify product titles in Shopify admin.</li>
          {% endif %}
        {% endpaginate %}
      </ul>
    </div>
    <!-- Main product display -->
    <div class="main-content">
      {% assign collection = collections['2025-state-fair-sale'] %}
      {% if collection and collection.products.size > 0 %}
        <div class="collection-products">
          {% assign sorted_products = collection.products | sort: 'title' %}
          {% assign current_prefix = '' %}
          {% for product in sorted_products %}
            {% assign title = product.title | strip | default: 'Unknown' %}
            {% assign words = title | split: ' ' %}
            {% if words.size >= 2 %}
              {% assign title_prefix = words | slice: 0, 2 | join: ' ' %}
            {% else %}
              {% assign title_prefix = title %}
            {% endif %}
            {% if title_prefix != current_prefix %}
              <h2 class="prefix-group" data-prefix="{{ title_prefix | escape }}">{{ title_prefix | escape }}</h2>
              {% assign current_prefix = title_prefix %}
            {% endif %}
            <div class="product-item" data-prefix="{{ title_prefix | escape }}">
              <a href="{{ product.url }}">
                <img
                  src="{{ product.featured_image | img_url: 'medium' | default: 'https://via.placeholder.com/200' }}"
                  alt="{{ product.title | escape | default: 'No Title' }}"
                  loading="lazy"
                >
                <h3>{{ product.title | escape | default: 'No Title' }}</h3>
                {% if customer and product.metafields.custom.state_fair_price %}
                  <span class="price original-price">Original: <s>{{ product.price | money }}</s></span>
                  <span class="price state-fair-price">Sale: {{ product.metafields.custom.state_fair_price | times: 100 | money }}</span>
                {% else %}
                  <span class="price regular-price">{{ product.price | money }}</span>
                {% endif %}
              </a>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No products available in this collection. Check collection handle or product assignments.</p>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .state-fair-deals-page {
    display: flex;
    flex-direction: column;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  .page-content {
    display: flex;
    gap: 20px;
  }
  .sidebar {
    width: 250px;
    flex-shrink: 0;
  }
  .vendor-list {
    list-style: none;
    padding: 0;
  }
  .vendor-list li {
    margin-bottom: 10px;
  }
  .vendor-link {
    text-decoration: none;
    color: #333;
    font-weight: bold;
  }
  .vendor-link.active,
  .vendor-link:hover {
    color: #33ff44;
  }
  .main-content {
    flex-grow: 1;
  }
  .collection-products {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }
  .product-item {
    text-align: center;
  }
  .product-item.hidden {
    display: none;
  }
  .prefix-group {
    display: block;
    grid-column: 1 / -1;
  }
  .prefix-group.hidden {
    display: none;
  }
  .state-fair-price {
    color: #33ff44;
    font-weight: bold;
    display: block;
  }
  .original-price {
    color: #666;
    font-size: 0.9em;
    display: block;
  }
  .original-price s {
    color: #999;
  }
  .regular-price {
    color: #333;
    font-weight: bold;
    display: block;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const vendorLinks = document.querySelectorAll('.vendor-link');
    const products = document.querySelectorAll('.product-item');
    const prefixGroups = document.querySelectorAll('.prefix-group');

    vendorLinks.forEach((link) => {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const filter = this.getAttribute('data-filter');

        // Update active link
        vendorLinks.forEach((l) => l.classList.remove('active'));
        this.classList.add('active');

        // Filter products and prefix groups
        products.forEach((item) => {
          item.classList.toggle('hidden', filter !== 'all' && item.getAttribute('data-prefix') !== filter);
        });
        prefixGroups.forEach((group) => {
          group.classList.toggle('hidden', filter !== 'all' && group.getAttribute('data-prefix') !== filter);
        });
      });
    });
  });
</script>